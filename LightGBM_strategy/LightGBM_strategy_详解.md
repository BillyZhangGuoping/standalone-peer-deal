# LightGBM_strategy 工作流程和逻辑详解

## 1. 策略整体架构

LightGBM_strategy 是一个基于机器学习的多品种期货交易策略，主要包含以下核心模块：

| 模块名称 | 主要功能 |
|---------|---------|
| 模型训练 | 训练LightGBM回归模型预测未来趋势强度 |
| 相关性矩阵 | 计算品种间相关性、波动率和ATR |
| 组合分配 | 基于风险平价进行资金分配和手数计算 |
| 每日调仓 | 模拟每日交易流程，生成目标头寸 |

## 2. 核心工作流程

### 2.1 初始化阶段
- 配置参数设置：资金规模、开始日期、风险比例等
- 初始化各个模块（模型训练、相关性矩阵计算、组合分配）
- 创建必要的目录结构

### 2.2 数据处理阶段
- **数据加载**：加载多个品种的历史日线数据
- **数据预处理**：对齐日期，处理缺失值，确保数据格式统一
- **主力合约处理**：确保每个品种都有正确的主力合约代码

### 2.3 模型训练阶段
- **训练频率**：每100天重新训练一次模型
- **特征工程**：计算28个技术指标：
  - 价格相关：open, high, low, close, volume
  - 移动平均线：ma5, ma10, ma20, ma60
  - 动量指标：momentum5, momentum10, momentum20
  - 波动率：volatility5, volatility10, volatility20
  - 收益率：return1, return5, return10
  - ATR相关：tr, atr
  - 量价关系：volume_change, price_volume_corr
- **标签构建**：使用未来3日收益率作为趋势强度标签
- **模型训练**：
  - 训练集：300个数据点
  - 测试集：60个数据点
  - LightGBM回归模型，2000轮训练

### 2.4 每日调仓流程
```
for 每个交易日:
    获取当前日期及之前的历史数据
    if 第一次运行 or 模型训练计数器 >= 100:
        重新训练所有品种的模型
        重置模型训练计数器
    重新计算相关性矩阵、波动率和ATR
    运行资金分配和手数计算
    保存每日目标头寸
    更新模型训练计数器
```

## 3. 每日目标头寸计算逻辑

### 3.1 趋势强度预测
- 使用训练好的LightGBM模型预测每个品种的未来3日趋势强度
- 趋势强度是一个连续值，表示预期收益率
- 确保特征工程与训练时保持一致

### 3.2 品种筛选
- 筛选出趋势强度绝对值大于阈值（0.001）的品种
- 确保只保留具有明显趋势的品种

### 3.3 风险平价资金分配
1. **获取品种列表**：只考虑筛选出的品种
2. **准备数据**：
   - 预期收益：模型预测的趋势强度
   - 波动率：每个品种的历史波动率
   - 相关性矩阵：品种间的相关系数
3. **风险平价计算**：
   - 计算协方差矩阵（基于相关性和波动率）
   - 迭代优化权重，使各品种的风险贡献相等
   - 调整权重符号与预期收益一致（正收益多头，负收益空头）
   - 归一化权重，确保资金分配合理

### 3.4 手数计算
```python
# 计算分配的资金绝对值
allocated_capital = abs(total_capital * weight)

# ATR-based仓位管理
position_size_abs = (allocated_capital * risk_coefficient) / (current_atr * multiplier)

# 四舍五入到整数
position_size_abs = int(round(position_size_abs))

# 根据信号确定最终的position_size符号
position_size = position_size_abs * signal  # 正数多头，负数空头
```

## 4. 影响目标头寸的主要因素

| 影响因素 | 具体说明 | 影响方式 |
|---------|---------|---------|
| **趋势强度** | 模型预测的未来3日收益率 | 决定仓位方向和大小 |
| **波动率** | 品种的历史波动率 | 影响资金分配比例（波动率高的品种分配较少资金） |
| **相关性矩阵** | 品种间的相关系数 | 影响风险平价分配，降低相关性高的品种集中度 |
| **ATR** | 平均真实波幅 | 用于计算头寸大小，控制每笔交易的风险 |
| **合约乘数** | 不同品种的合约乘数 | 影响手数计算（乘数大的品种手数少） |
| **保证金率** | 不同品种的保证金要求 | 影响可用资金和最大持仓量 |
| **风险系数** | 每笔交易愿意承担的风险比例 | 影响整体仓位大小（风险系数大，仓位大） |
| **总资金规模** | 策略可用的总资金 | 影响所有品种的仓位大小 |
| **单品种风险限制** | 单品种保证金占用不超过总资金的10% | 防止单一品种风险过大 |

## 5. 关键技术特点

1. **机器学习预测**：使用LightGBM回归模型预测未来趋势强度
2. **风险平价分配**：确保各品种风险贡献相等，降低整体组合风险
3. **ATR仓位管理**：基于ATR动态调整仓位大小，控制风险
4. **定期模型更新**：每100天重新训练模型，适应市场变化
5. **无未来数据泄露**：所有计算严格使用当前日期及之前的数据
6. **每日重新平衡**：每日重新计算相关性和仓位，确保使用最新市场信息

## 6. 目标头寸文件格式

每日目标头寸保存为CSV文件，包含以下字段：
- symbol：合约代码
- current_price：当前价格
- contract_multiplier：合约乘数
- position_size：目标持仓手数（正数多头，负数空头）
- position_value：持仓价值
- margin_usage：保证金占用
- risk_amount：风险金额
- margin_rate：保证金率
- total_capital：总资金
- signal：交易信号（1多头，-1空头）
- model_type：模型类型
- market_value：市值
- allocated_capital：分配的资金
- atr：平均真实波幅

## 7. 策略优势与风险

### 优势
- 多品种分散投资，降低单一品种风险
- 基于机器学习的趋势预测，捕捉市场趋势
- 风险平价分配，控制整体组合风险
- ATR仓位管理，动态调整风险敞口

### 风险
- 模型预测误差风险
- 市场极端行情风险
- 高杠杆交易风险
- 流动性风险